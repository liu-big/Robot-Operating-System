# `goal_test1.py` 脚本使用开发操作手册

## 1. 概述

`goal_test1.py` 是一个 ROS (Robot Operating System) Python 脚本，旨在控制机器人导航至一系列预设的导航点，并在到达每个导航点附近时执行特定操作（例如，根据距离判断是否进行图像捕获）。该脚本利用 ROS 的 `move_base` 导航栈来实现目标点的发送和状态监控，并结合 `tf` 库进行坐标变换的监听，以实时计算机器人与目标点之间的距离。此外，它还集成了图像处理功能，尽管在提供的代码片段中图像保存部分被注释掉，但其设计意图是支持在特定条件下进行拍照。

## 2. 脚本结构

```
src/
├── goal_test1.py             # 主脚本文件
└── goal_test1_manual.md      # 本文档
```

### 2.1 主要变量

- `xy`: 存储导航点的坐标 (x, y, yaw)。
- `pose_num`: 导航点的数量。
- `qtn_list`: 存储由 `xy` 中的 yaw 转换而来的四元数列表。
- `voice_play`: 语音播放路径（在提供的代码中未直接使用）。
- `car_to_goal_x`, `car_to_goal_y`: 实时存储小车当前在 `map` 坐标系下的 x, y 坐标。
- `distance`: 机器人与当前目标点之间的距离。
- `latest_frame`, `crop`, `camera`, `destroy`, `cam`, `gg`: 与图像处理和控制流程相关的标志变量。
- `processing_lock`, `stop_processing`: 用于线程同步和停止图像处理的标志。

### 2.2 主要函数

- `dis(x, y)`:
  - **功能**：实时监听机器人 (`base_link`) 在 `map` 坐标系下的位置，并计算机器人与给定目标点 `(x, y)` 之间的欧氏距离。
  - **用途**：在导航过程中持续监控机器人与目标点的距离，当距离小于阈值时停止。
- `goals(x, y, i, count)`:
  - **功能**：向 `move_base` 发送一个导航目标点，并启动一个线程 (`dis`) 来监控导航进度。在导航完成后，根据距离判断是否执行图像保存操作（当前代码中已注释）。
  - **用途**：驱动机器人导航到指定的导航点。
- `go_home(x, y, i)`:
  - **功能**：处理导航到最后一个点（通常是“回家”点）的逻辑。在提供的代码中，它也向 `move_base` 发送目标，并监控距离。
  - **用途**：在完成所有导航任务后，引导机器人返回预设的“家”位置或安全区。

## 3. 主要功能与用途

- **多点导航**：机器人按照预设的 `xy` 坐标列表依次导航到每个目标点。
- **实时距离监控**：在导航过程中，脚本会持续计算机器人与当前目标点之间的距离，并根据距离判断是否到达目标。
- **坐标变换**：利用 `tf` 库进行坐标系之间的变换监听，获取机器人当前在全局地图坐标系下的位置。
- **图像捕获（潜在功能）**：代码中包含图像捕获和保存的逻辑（目前被注释），表明该脚本设计用于在到达导航点后进行拍照。

## 4. 使用方法

### 4.1 依赖

确保您的 ROS 环境中安装了以下必要的 ROS 包和 Python 库：

- `rospy`
- `tf`
- `actionlib`
- `move_base_msgs`
- `geometry_msgs`
- `sensor_msgs`
- `numpy`
- `cv2` (OpenCV Python 库)
- `ctypes` (Python 标准库)

### 4.2 配置导航点

修改脚本中的 `xy` 列表来定义您的导航点。每个子列表应包含 `[x, y, yaw]`，其中 `yaw` 是机器人到达该点时的期望朝向（弧度）。

```python
xy = [[2.9631063000692928, -0.19845071289273267, -1.6994449527149291], 
      [2.9699946355935354, -4.079984961831021, 1.6275405602410764], 
      # ... 更多导航点
      [0.900197608047419, -0.20358226304161914, -1.5778584895002257]]
```

### 4.3 运行脚本

1. **启动 ROS 环境**：确保您的 ROS Master (`roscore`) 正在运行，并且 `move_base` 导航栈已正确配置并启动。
2. **运行脚本**：
   ```bash
   rosrun your_package_name goal_test1.py
   ```
   （请将 `your_package_name` 替换为 `goal_test1.py` 所在的实际 ROS 包名）

## 5. 项目全局应用

在 `ucar_ws` 项目中，`goal_test1.py` 脚本可以作为以下应用场景的基础或示例：

- **自动化巡检**：机器人按照预设路径巡逻，并在特定地点进行数据采集（如拍照、扫描）。
- **定点作业**：机器人导航到指定位置执行任务，例如货物搬运、环境监测等。
- **导航测试与调试**：用于测试 `move_base` 导航栈在复杂环境或多点任务下的性能和鲁棒性。
- **演示系统**：作为机器人自主导航和任务执行的演示案例。

## 6. 维护与更新

- **导航点更新**：根据实际任务需求，定期更新 `xy` 列表中的导航点。
- **图像处理逻辑**：如果需要启用或修改图像捕获和保存功能，请取消注释并完善相关代码。
- **错误处理**：增强 `try-except` 块，处理 `tf` 查找失败、`move_base` 目标取消等异常情况。
- **参数化**：考虑将导航点、距离阈值等参数通过 ROS 参数服务器进行配置，提高脚本的灵活性。

## 7. 故障排除

- **机器人不移动或无法到达目标点**：
  - **原因**：`move_base` 导航栈未正确启动或配置，地图问题，或者目标点不可达。
  - **解决方案**：
    - 检查 `move_base` 节点的日志输出，查找错误信息。
    - 使用 Rviz 可视化地图、机器人位置、导航目标和路径，检查是否存在障碍物或地图不匹配。
    - 确保 `map` 和 `base_link` 之间的 TF 变换正常发布。
- **`tf.TransformListener` 警告/错误**：
  - **原因**：通常是 TF 树中缺少必要的变换（例如 `map` 到 `base_link` 的变换），或者时间戳问题。
  - **解决方案**：
    - 确保 `robot_state_publisher`、`amcl`（或其它定位节点）等正在运行并正确发布 TF 变换。
    - 使用 `rosrun tf view_frames` 检查 TF 树的完整性。
- **图像捕获问题**：
  - **原因**：摄像头未正确连接或驱动，OpenCV 安装问题，或者文件保存路径权限问题。
  - **解决方案**：
    - 检查摄像头是否正常工作。
    - 确保 OpenCV 库已正确安装。
    - 检查脚本运行用户对保存路径是否有写入权限。
- **脚本意外退出**：
  - **原因**：未捕获的异常，或者 ROS 节点关闭。
  - **解决方案**：
    - 检查终端输出的 Python 错误回溯信息。
    - 确保所有 ROS 相关的操作都在 `rospy.is_shutdown()` 检查范围内，或者有适当的异常处理。